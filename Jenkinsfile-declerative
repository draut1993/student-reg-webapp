pipeline{
    agent any
    environment{
        SONAR_TOKEN = credentials('sonarToken')
        TOMCAT_SERVER = 'ec2-user@54.226.53.118'
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))      // Keep last 5 builds only
        disableConcurrentBuilds()                          // Prevent parallel runs of same job
        timeout(time: 15, unit: 'MINUTES')                 // Stop pipeline if exceeds 15 mins
    }
    triggers {
        githubPush()    // Automatically triggers pipeline on GitHub push
    }
    tools{
        maven 'Maven_build'
    }
    stages{
        stage("Git clone"){
            steps{
              git branch: 'main', changelog: false, credentialsId: 'Jenkins-credentials', poll: false, url: 'https://github.com/draut1993/student-reg-webapp.git'  
            }
        }
        
        stage("Maven build"){
            steps{
                sh "mvn clean package"
            }
        }
        
        stage("Sonar check"){
            steps{
                sh "mvn sonar:sonar -Dsonar.host.url=http://50.16.165.60:9000/ -Dsonar.token=${SONAR_TOKEN}"
            }
        }
        
        stage("Upload build artifact to nexus"){
            steps{
                sh "mvn clean deploy"
            }
        }
        
        stage("deploy app to tomcat server"){
            steps{
                sshagent(['Tomcat_server_SSH_Agent']) {
                sh """
                ssh -o StrictHostKeyChecking=no ${TOMCAT_SERVER} 'sudo /home/ec2-user/apache-tomcat-9.0.110/bin/shutdown.sh'
                sleep 20
                ssh -o StrictHostKeyChecking=no ${TOMCAT_SERVER} 'sudo rm -f /home/ec2-user/apache-tomcat-9.0.110/webapps/student-reg-webapp.war || true'
                scp -o StrictHostKeyChecking=no target/student-reg-webapp.war ${TOMCAT_SERVER}:/home/ec2-user/apache-tomcat-9.0.110/webapps/
                ssh -o StrictHostKeyChecking=no ${TOMCAT_SERVER} 'sudo /home/ec2-user/apache-tomcat-9.0.110/bin/startup.sh'
                """
   
}
            }
        }
    }
     post {

        success {
            echo "‚úÖ Build Successful!"
            mail to: 'draut3078@gmail.com',
                subject: "‚úÖ SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """\
Hello Deepak,

üéâ Good news! Your Jenkins build *${env.JOB_NAME}* (Build #${env.BUILD_NUMBER}) completed **successfully**.

üìÇ Job URL: ${env.BUILD_URL}

‚úÖ Status: SUCCESS  
üïí Duration: ${currentBuild.durationString}

Regards,  
Jenkins CI/CD Pipeline  
"""
        }

        failure {
            echo "‚ùå Build Failed!"
            mail to: 'draut3078@gmail.com',
                subject: "‚ùå FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """\
Hello Deepak,

üö® Your Jenkins job *${env.JOB_NAME}* (Build #${env.BUILD_NUMBER}) **failed**.

üìÇ Job URL: ${env.BUILD_URL}

‚ùó Please review the console output and fix the issue.

Regards,  
Jenkins CI/CD Pipeline  
"""
        }

        unstable {
            echo "‚ö†Ô∏è Build Unstable!"
            mail to: 'draut3078@gmail.com',
                subject: "‚ö†Ô∏è UNSTABLE: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """\
Hello Deepak,

‚ö†Ô∏è Your Jenkins job *${env.JOB_NAME}* (Build #${env.BUILD_NUMBER}) is **unstable** (tests or quality checks failed).

üìÇ Job URL: ${env.BUILD_URL}

Please investigate.

Regards,  
Jenkins CI/CD Pipeline  
"""
        }

        always {
            echo "üì¶ Build completed (Success/Fail/Unstable)"
        }
    }
}